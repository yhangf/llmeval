# 自动清理功能说明

## 概述

系统现在具备自动清理功能，会自动管理任务记录、评估历史和日志文件，只保留最近的5个任务相关数据，防止系统存储空间无限增长。

## 清理策略

### 任务记录清理
- **触发时机**：
  - 系统启动时（TaskManager初始化）
  - 每次创建新任务时
  - 任务完成或失败时
- **保留数量**：最近的5个任务
- **清理内容**：
  - 任务JSON文件 (`data/tasks/*.json`)
  - 内存中的任务数据
- **排序方式**：按任务创建时间倒序排列

### 评估历史清理
- **触发时机**：任务完成并更新评估历史时
- **保留数量**：最近的5个评估记录
- **清理内容**：
  - 模型评估历史记录 (`data/model_evaluation_history.json`)
- **排序方式**：按评估创建时间倒序排列

### 日志文件清理
- **触发时机**：任务完成时
- **保留数量**：最近的5个任务日志
- **清理内容**：
  - 评估日志文件 (`logs/*.log`)
  - 对应的JSON结果文件 (`logs/*.json`)
- **排序方式**：按日志创建时间倒序排列

## 实现细节

### 1. 任务管理器清理 (`core/task_manager.py`)

```python
def cleanup_old_tasks(self, max_tasks: int = 5):
    """清理旧任务，只保留最近的N个任务"""
    # 按创建时间排序，删除超出限制的旧任务
    # 同时删除对应的文件和内存数据
```

**调用位置**：
- `__init__()` 方法中（系统启动时）
- `create_task()` 方法中（创建新任务时）
- `update_task_status()` 方法中（任务完成或失败时）

### 2. 评估历史清理 (`utils/model_evaluation_history.py`)

```python
def cleanup_old_evaluations(self, max_records: int = 5):
    """清理旧的评估记录，只保留最近的N个"""
    # 重建评估历史数据，只保留最新的记录
```

**调用位置**：`run_evaluation()` 函数完成后

### 3. 日志文件清理 (`utils/log_viewer.py`)

```python
def cleanup_old_task_logs(max_tasks: int = 5):
    """清理旧任务的日志文件，只保留最近N个任务的日志"""
    # 删除旧的日志文件和对应的JSON文件
```

**调用位置**：`run_evaluation()` 函数完成后

## 用户界面提示

### 任务列表界面
- 当任务数量 ≥ 5 时：显示蓝色信息提示，说明会自动清理旧任务
- 当任务数量 < 5 时：显示绿色成功提示，说明当前任务数量
- 空任务时：提示系统会自动保留最近5个任务记录

### 提示信息示例
```
ℹ️ 当前显示 6 个任务，系统会自动保留最近的5个任务记录，旧任务会被自动清理
✅ 当前有 3 个任务记录，系统会自动保留最近的5个任务
```

## 清理日志

系统会在控制台输出清理操作的详细信息：

```
自动清理旧任务: task_id_123 (创建于: 2025-06-24T18:38:06.950929)
自动清理完成，删除了 1 个旧任务，保留最近的 5 个任务

自动清理评估历史，删除了 1 个旧记录，保留最近的 5 个记录

🧹 自动清理旧任务日志，保留最近 5 个任务的日志...
🗑️  删除旧日志: evaluation_log_20250624_183806.log
✅ 自动清理完成，删除了 1 个旧任务日志，保留最近的 5 个任务日志
```

## 配置参数

目前清理参数硬编码为5，如需修改可在以下位置调整：

1. **任务清理**：`core/task_manager.py` 中的 `cleanup_old_tasks(max_tasks=5)`
2. **评估历史清理**：`main.py` 中的 `cleanup_old_evaluations(max_records=5)`
3. **日志清理**：`main.py` 中的 `cleanup_old_task_logs(max_tasks=5)`

## 数据安全

- 清理操作只在新任务创建或完成时触发，不会意外删除正在运行的任务
- 清理前会检查数据完整性，确保不会删除重要数据
- 所有清理操作都有详细的日志记录
- 清理操作使用文件锁机制，避免并发冲突

## 注意事项

1. **数据持久性**：被清理的数据将永久删除，无法恢复
2. **存储优化**：此功能主要用于防止系统存储空间无限增长
3. **性能影响**：清理操作对系统性能影响很小，通常在毫秒级完成
4. **手动清理**：用户仍可以手动删除任务，不会影响自动清理机制

## 测试验证

已通过自动化测试验证功能正确性：
- 创建超过5个任务时自动清理最旧的任务
- 评估历史记录正确同步清理
- 日志文件按时间正确清理
- 清理后数据完整性保持正确

## 未来扩展

可能的功能扩展：
- 可配置的保留数量
- 基于存储空间的智能清理
- 清理策略的用户自定义选项
- 清理操作的撤销功能（在一定时间内） 